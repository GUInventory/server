# Migration `20201111173058-add-missing-relations`

This migration has been generated by Balint.Kiraly1 <balint.kiraly@protonmail.com> at 11/11/2020, 6:30:58 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
ALTER TABLE "public"."Category" DROP CONSTRAINT "Category_categoryId_fkey"

ALTER TABLE "public"."Attribute" ALTER COLUMN "itemId" SET NOT NULL

ALTER TABLE "public"."AttributeType" ALTER COLUMN "categoryId" SET NOT NULL

ALTER TABLE "public"."Category" DROP COLUMN "categoryId",
ADD COLUMN "parentId" integer   

ALTER TABLE "public"."Item" ALTER COLUMN "storageId" SET NOT NULL

ALTER TABLE "public"."Outgoing" ALTER COLUMN "itemId" SET NOT NULL

CREATE TABLE "public"."_CategoryToItem" (
"A" integer   NOT NULL ,
"B" integer   NOT NULL 
)

CREATE UNIQUE INDEX "_CategoryToItem_AB_unique" ON "public"."_CategoryToItem"("A", "B")

CREATE INDEX "_CategoryToItem_B_index" ON "public"."_CategoryToItem"("B")

ALTER TABLE "public"."_CategoryToItem" ADD FOREIGN KEY("A")REFERENCES "public"."Category"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."_CategoryToItem" ADD FOREIGN KEY("B")REFERENCES "public"."Item"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."Category" ADD FOREIGN KEY("parentId")REFERENCES "public"."Category"("id") ON DELETE SET NULL ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20201107132411-fix-relations..20201111173058-add-missing-relations
--- datamodel.dml
+++ datamodel.dml
@@ -1,10 +1,10 @@
 // This is your Prisma schema file,
 // learn more about it in the docs: https://pris.ly/d/prisma-schema
 datasource db {
-  provider = "mysql"
-  url = "***"
+  provider = "postgresql"
+  url = "***"
 }
 generator client {
   provider = "prisma-client-js"
@@ -41,9 +41,9 @@
   roleType  RoleType
   createdAt   DateTime @default(now())
   updatedAt   DateTime @updatedAt
-  User        User?    @relation(fields: [userId], references: [id])
+  user        User?    @relation(fields: [userId], references: [id])
   userId      Int?
   warehouseId Int
 }
@@ -80,12 +80,13 @@
 model Item {
   id         Int         @id @default(autoincrement())
   name       String
   image      String
-  storage    Storage?    @relation("StorageToItem", fields: [storageId], references: [id])
+  storage    Storage     @relation("StorageToItem", fields: [storageId], references: [id])
   value      Int
   outgoings  Outgoing[]
   attributes Attribute[]
+  categories Category[]  @relation("CategoryToItem")
   positionX Int
   positionY Int
   positionZ Int
@@ -94,48 +95,49 @@
   sizeZ     Int
   createdAt DateTime @default(now())
   updatedAt DateTime @updatedAt
-  storageId Int?
+  storageId Int
 }
 model Outgoing {
   id          Int      @id @default(autoincrement())
   description String
   value       Int
   createdAt   DateTime @default(now())
   updatedAt   DateTime @updatedAt
-  Item        Item?    @relation(fields: [itemId], references: [id])
-  itemId      Int?
+  item        Item     @relation(fields: [itemId], references: [id])
+  itemId      Int
 }
 model Category {
   id         Int             @id @default(autoincrement())
   name       String
   color      String
-  parent     Category?       @relation("CategoryToCategory", fields: [categoryId], references: [id])
+  parent     Category?       @relation("CategoryToCategory", fields: [parentId], references: [id])
   attributes AttributeType[]
   createdAt  DateTime        @default(now())
   updatedAt  DateTime        @updatedAt
   children   Category[]      @relation("CategoryToCategory")
-  categoryId Int?
+  parentId   Int?
+  items      Item[]          @relation("CategoryToItem")
 }
 model AttributeType {
   id         Int               @id @default(autoincrement())
   type       AttributeTypeEnum
   name       String
   createdAt  DateTime          @default(now())
   updatedAt  DateTime          @updatedAt
-  Category   Category?         @relation(fields: [categoryId], references: [id])
-  categoryId Int?
+  category   Category          @relation(fields: [categoryId], references: [id])
+  categoryId Int
 }
 model Attribute {
   id        Int               @id @default(autoincrement())
   type      AttributeTypeEnum
   value     String
   createdAt DateTime          @default(now())
   updatedAt DateTime          @updatedAt
-  Item      Item?             @relation(fields: [itemId], references: [id])
-  itemId    Int?
+  item      Item              @relation(fields: [itemId], references: [id])
+  itemId    Int
 }
```


